<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>กำลังเชื่อมต่อ Roblox...</title>
<meta name="referrer" content="no-referrer" />
<style>
  :root{--bg1:#0b0d12;--bg2:#12121a;--accent:#06b6d4}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#fff;font-family:Poppins,system-ui,Arial}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:20px}
  .card{background:rgba(255,255,255,0.03);backdrop-filter:blur(8px);padding:28px;border-radius:14px;max-width:720px;width:100%;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.6)}
  .loader{width:72px;height:72px;border-radius:50%;border:8px solid rgba(255,255,255,.06);border-top-color:var(--accent);animation:spin 1s linear infinite;margin:0 auto 18px}
  @keyframes spin{to{transform:rotate(360deg)}}
  h1{margin:0 0 6px;font-size:20px}
  p{margin:0 0 14px;color:#cfd8dc}
  .mute{font-size:13px;color:#98a0a6;margin-top:8px}
  .btn{display:inline-block;margin:10px 6px;padding:10px 18px;border-radius:10px;border:0;background:linear-gradient(90deg,#7c3aed,#06b6d4);color:#fff;font-weight:700;cursor:pointer}
  .small{font-size:13px;color:#bfc9d1;margin-top:10px;word-break:break-word}
  .fallback{margin-top:14px;color:#ffd2a6}
  a.inline{color:var(--accent);text-decoration:underline}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="loader" aria-hidden="true"></div>
      <h1 id="title">กำลังเชื่อมต่อ Roblox…</h1>
      <p id="desc">ระบบกำลังเปิดแอป Roblox และพาคุณเข้าเกม (ถ้าแอปติดตั้งอยู่) — ถ้าไม่ เดี๋ยวจะมีวิธีสำรองให้</p>

      <div id="actions" style="display:none">
        <button class="btn" id="openBtn">เปิด Roblox อีกครั้ง</button>
        <button class="btn" id="webBtn">เปิดในเบราว์เซอร์ (หน้าเกม)</button>
      </div>

      <div class="fallback" id="fallback" style="display:none">
        ถ้าหน้าไม่สามารถเปิดแอปได้ ให้กดลิงก์นี้หรือคัดลอกแล้วเปิดในแอป Roblox:<br>
        <div class="small" id="linkBox"></div>
        <div class="mute">ถ้าเป็นมือถือ บางเบราว์เซอร์ (เช่น Safari/Chrome บางเวอร์ชัน) อาจไม่ยอมเปิด deep link อัตโนมัติ — ให้ลองคัดลอกลิงก์และเปิดในแอปหรือใช้แอป Notes/ข้อความเพื่อนำไปเปิด (workaround ของบางระบบ). </div>
      </div>
    </div>
  </div>

<script>
/*
  Usage:
    Put this index.html in your GitHub Pages. To join:
    https://<user>.github.io/<repo>/join/{GAME_ID}/{LINK_CODE}
  Examples of LINK_CODE:
    - Roblox "share" link codes (UUID-like), e.g. 6047ad07-...
    - If you only need placeId, make second param optional.
*/

/* --- Config --- */
const DEFAULT_WAIT_MS = 2000; // time to wait then attempt redirect
const FALLBACK_SHOW_MS = 1200; // show fallback/actions after failures

/* --- Helpers --- */
function pathSegments(){
  const p = location.pathname.replace(/\/+$/, '').split('/');
  // find 'join' segment then next two parts
  const i = p.findIndex(s => s.toLowerCase() === 'join');
  if(i === -1) return null;
  return { gameId: p[i+1] || null, code: p[i+2] || null };
}

function makeShareUrl(code){
  // Roblox share link format (server link) -> https://www.roblox.com/share?code=...&type=Server
  return code ? `https://www.roblox.com/share?code=${encodeURIComponent(code)}&type=Server` : null;
}

function makeGamePageUrl(gameId){
  // experience/game url (open web game page)
  return gameId ? `https://www.roblox.com/games/${encodeURIComponent(gameId)}` : 'https://www.roblox.com/';
}

/* --- deep link attempts --- */
function attemptOpenDeepLink(gameId, code){
  // 1) Preferroblox protocol deep link for desktop/Windows / mac (best-effort)
  // Format examples used by community tools: "roblox-player:1+launchmode=play+gameId=...+privateServerLinkCode=..."
  // This format is not officially documented and may change. We include fields best-effort.
  let protocolParts = ['roblox-player:1+launchmode=play'];
  if(gameId) protocolParts.push(`gameId=${encodeURIComponent(gameId)}`);
  if(code) protocolParts.push(`privateServerLinkCode=${encodeURIComponent(code)}`);
  const proto = protocolParts.join('+');

  // 2) Also try "robloxmobile://..." pattern (some mobile handlers accept robloxmobile://")
  const mobileProto = code
    ? `robloxmobile://launch?placeId=${encodeURIComponent(gameId)}&visit=true&privateServerLinkCode=${encodeURIComponent(code)}`
    : `robloxmobile://launch?placeId=${encodeURIComponent(gameId)}&visit=true`;

  // Strategy:
  // - create an iframe navigation (older trick) and fallback to location.href
  // - measure visibility change or timeouts to guess success (best-effort)
  const tryProto = proto;
  const tryMobile = mobileProto;

  // Try in sequence with small delays
  setTimeout(()=> tryNavigate(tryProto), 100);
  setTimeout(()=> tryNavigate(tryMobile), 800);

  // final fallback: redirect to share link (roblox web share) after timeout
  setTimeout(()=> {
    showActions();
    const share = makeShareUrl(code);
    if(share) {
      // also set fallback UI link
      document.getElementById('linkBox').textContent = share;
      document.getElementById('fallback').style.display = 'block';
      // open share URL to let Roblox web handle deferred deep linking
      window.location.href = share;
    } else {
      document.getElementById('fallback').style.display = 'block';
      document.getElementById('linkBox').textContent = makeGamePageUrl(gameId);
    }
  }, DEFAULT_WAIT_MS + 900);
}

function tryNavigate(url){
  if(!url) return;
  try {
    // create invisible iframe for some browsers
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = url;
    document.body.appendChild(iframe);
    // remove after a bit
    setTimeout(()=> { try{ document.body.removeChild(iframe); } catch(e){} }, 1000);
    // also attempt location replace (some browsers only accept top-level navigation)
    // but don't use replace immediately to allow iframe a chance
    setTimeout(()=> { window.location.href = url; }, 500);
  } catch(e){
    try { window.location.href = url; } catch(_){}
  }
}

/* --- UI --- */
function showActions(){
  const actions = document.getElementById('actions');
  actions.style.display = 'block';
  document.getElementById('openBtn').onclick = () => {
    const seg = pathSegments();
    attemptOpenDeepLink(seg && seg.gameId, seg && seg.code);
  };
  document.getElementById('webBtn').onclick = () => {
    const seg = pathSegments();
    window.open(makeGamePageUrl(seg && seg.gameId), '_blank');
  };
}

/* --- Main --- */
(function main(){
  const seg = pathSegments();
  const title = document.getElementById('title');
  const desc = document.getElementById('desc');
  if(!seg || (!seg.gameId && !seg.code)){
    title.textContent = 'ลิงก์ไม่ถูกต้อง';
    desc.textContent = 'รูปแบบ: /join/{GAME_ID}/{LINK_CODE}  — ตัวอย่าง: /join/127742093697776/6047ad07-df68-4580-b126-4d7b9082bfd9';
    document.getElementById('fallback').style.display = 'block';
    document.getElementById('linkBox').textContent = window.location.href;
    return;
  }

  // show readable info
  if(seg.code){
    desc.textContent = `เปิดลิงก์ Private Server (code) — พยายามเปิดแอปแล้ว ถ้าไม่สำเร็จจะไปยังหน้า Roblox share.`;
  } else {
    desc.textContent = `เปิดหน้าประสบการณ์ (place) แล้วพาคุณเข้าเกม — พยายามเปิดแอปแล้ว ถ้าไม่สำเร็จจะไปยังหน้าเกมบนเว็บ.`;
  }

  // set fallback link box early
  const share = makeShareUrl(seg.code);
  document.getElementById('linkBox').textContent = share || makeGamePageUrl(seg.gameId);

  // Try to open
  setTimeout(()=> attemptOpenDeepLink(seg.gameId, seg.code), 600);
})();
</script>
</body>
</html>
